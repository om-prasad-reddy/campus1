<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus1 - Notifications</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Keep all existing styles here */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
          
        }
        
        /* Modal Styles for Logout */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease-out;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .modal-header {
            background: linear-gradient(135deg, #6b46c1, #3b82f6);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        .modal-header h3 i {
            margin-right: 10px;
        }
        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        .close:hover {
            color: #f1f5f9;
        }
        .modal-body {
            padding: 30px;
        }
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }
        .btn-cancel {
            background: #6b7280;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        .btn-cancel:hover {
            background: #4b5563;
        }
        .btn-save {
            background: linear-gradient(135deg, #6b46c1, #3b82f6);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-save:hover {
            background: linear-gradient(135deg, #553c9a, #2563eb);
            transform: translateY(-1px);
        }
        
        .header {
            background: linear-gradient(90deg, #6b46c1, #4c51bf);
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 20%;
            width: calc(80% - 40px);
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            height: 60px;
        }
        .header .logo {
            display: flex;
            align-items: center;
        }
        .header .logo i {
            font-size: 28px;
            margin-right: 12px;
            color: #60a5fa;
        }
        .header .logo span {
            font-size: 28px;
            font-weight: bold;
            color: #f472b6;
        }
        .header .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .header .date-time {
            background-color: #34d399;
            padding: 8px 15px;
            border-radius: 18px;
            font-size: 16px;
            display: flex;
            align-items: center;
            font-weight: 500;
        }
        .header .date-time i {
            margin-right: 5px;
        }
        .profile-section {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 8px;
        }
        .admin-info {
            text-align: right;
        }
        .admin-name {
            font-size: 14px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 2px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .admin-email {
            font-size: 12px;
            color: #e5e7eb;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .profile-avatar {
            position: relative;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid #60a5fa;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #6b74db;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        .profile-avatar:hover {
            border-color: #f472b6;
            transform: scale(1.05);
        }
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .sidebar {
            width: 20%;
            background: linear-gradient(180deg, #3b82f6, #2563eb);
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            padding-top: 25px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.15);
            z-index: 900;
        }
        .sidebar h2 {
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            margin: 0 0 30px 0;
            padding: 0 20px;
            color: #f1f5f9;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-bottom: 2px solid rgba(255,255,255,0.1);
            padding-bottom: 15px;
        }
        .sidebar a {
            display: flex;
            align-items: center;
            color: white;
            padding: 16px 25px;
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            margin: 2px 0;
        }
        .sidebar a i {
            margin-right: 15px;
            font-size: 18px;
            width: 20px;
            text-align: center;
            transition: transform 0.3s ease;
        }
        .sidebar a:hover {
            background: linear-gradient(90deg, #1e40af, #2563eb);
            border-left: 4px solid #60a5fa;
            padding-left: 30px;
            box-shadow: inset 0 0 20px rgba(255,255,255,0.1);
            transform: translateX(5px);
        }
        .sidebar a:hover i {
            transform: scale(1.2);
            color: #60a5fa;
        }
        .sidebar a.active {
            background: linear-gradient(90deg, #1e40af, #2563eb);
            border-left: 4px solid #60a5fa;
        }
        .main-content {
            margin-left: 20%;
            padding: 90px 30px 30px;
            background-color: #f5f7fa;
            min-height: calc(100vh - 90px);
        }
        .notification-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .notification-header h1 {
            margin: 0;
            color: #1e3a8a;
        }
        .notification-controls {
            display: flex;
            gap: 15px;
        }
        .refresh-btn {
            background: linear-gradient(135deg, #6b46c1, #3b82f6);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        .refresh-btn:hover {
            background: linear-gradient(135deg, #553c9a, #2563eb);
            transform: translateY(-2px);
        }
        .refresh-btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }
        .refresh-btn.loading i {
            animation: spin 1s linear infinite;
        }
        .notification-layout {
            display: flex;
            gap: 30px;
        }
        .notification-column {
            flex: 1;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .column-header {
            background: linear-gradient(135deg, #6b46c1, #3b82f6);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .column-header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .column-header-title i {
            font-size: 24px;
        }
        .column-header-title h2 {
            margin: 0;
            font-size: 22px;
            font-weight: 600;
        }
        .stats-section {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        .stat-box {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            min-width: 100px;
        }
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
            display: block;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #3b82f6;
        }
        .notification-history {
            padding: 25px;
            max-height: calc(100vh - 350px);
            overflow-y: auto;
        }
        .notification-item {
            background: #ffffff; /* White for read */
            border-left: 4px solid #6b7280; /* Gray for read */
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 0 10px 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
        }
        .notification-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .notification-item.unread {
            background: #e6f3ff; /* Light blue for unread */
            border-left-color: #3b82f6; /* Blue for unread */
        }
        .notification-item.loading {
            pointer-events: none;
            opacity: 0.7;
        }
        .notification-item.loading::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            z-index: 1;
        }
        .notification-item.loading .notification-spinner {
            display: block;
        }
        .notification-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }
        .notification-spinner i {
            font-size: 24px;
            color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        .notification-subject {
            font-weight: 600;
            color: #1e3a8a;
            margin-bottom: 12px;
            font-size: 18px;
        }
        .notification-message {
            color: #4b5563;
            margin-bottom: 15px;
            font-size: 16px;
            line-height: 1.5;
        }
        .notification-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notification-status {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            padding: 5px 10px;
            border-radius: 20px;
            background-color: #f3f4f6;
        }
        .notification-status.unread {
            color: #3b82f6;
            font-weight: 600;
            background-color: #dbeafe;
        }
        .notification-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-size: 12px;
            color: #6b7280;
        }
        .notification-time {
            margin-bottom: 5px;
        }
        .notification-priority {
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .priority-high {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .priority-medium {
            background-color: #fef3c7;
            color: #a16207;
        }
        .priority-normal {
            background-color: #f0fdf4;
            color: #166534;
        }
        .no-notifications {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        .no-notifications i {
            font-size: 64px;
            color: #d1d5db;
            margin-bottom: 20px;
        }
        .clear-all-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }
        .clear-all-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        .clear-all-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .clear-all-btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }
        .clear-all-btn.loading i {
            animation: spin 1s linear infinite;
        }
        .clear-all-btn i {
            font-size: 14px;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        .loading i {
            font-size: 32px;
            color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            background-color: #fef2f2;
            border-left: 4px solid #ef4444;
            color: #b91c1c;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
            display: flex;
            align-items: center;
        }
        .error-message i {
            margin-right: 15px;
            color: #ef4444;
            font-size: 24px;
        }
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 30px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            font-size: 18px;
            z-index: 10000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            justify-content: center;
        }
        .toast.show {
            opacity: 1;
            visibility: visible;
        }
        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        .toast.loading {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        .toast i {
            font-size: 24px;
        }
        .toast.loading i {
            animation: spin 1s linear infinite;
        }
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .page-loader.active {
            opacity: 1;
            visibility: visible;
        }
        .page-loader-content {
            text-align: center;
        }
        .page-loader i {
            font-size: 48px;
            color: #3b82f6;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        .page-loader p {
            font-size: 18px;
            color: #4b5563;
            font-weight: 500;
        }
        @media (max-width: 1200px) {
            .notification-layout {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <i class="fas fa-graduation-cap"></i>
            <span>Campus1</span>
        </div>
        <div class="header-right">
            <div class="date-time">
                <i class="fas fa-check-circle"></i>
                <span id="current-datetime"></span>
            </div>
            <div class="profile-section">
                <div class="admin-info">
                    <div class="admin-name">Admin User</div>
                    <div class="admin-email">admin@campus1.com</div>
                </div>
                <div class="profile-avatar" id="profile-avatar" onclick="viewProfilePicture()">
                    <!-- Profile image will be loaded from localStorage or initials will be shown -->
                </div>
            </div>
        </div>
    </div>
    <div class="sidebar">
        <h2>Admin Dashboard</h2>
        <a href="/admin/admin_profile.html"><i class="fas fa-user-shield"></i> Admin Profile</a>
        <a href="/admin/resume_users_data.html"><i class="fas fa-file-alt"></i> Task</a>
        <a href="/admin/notifications.html" class="active"><i class="fas fa-bell"></i> Notifications</a>
        <a href="/admin/ticket.html"><i class="fas fa-ticket-alt"></i> Ticket</a>
        <a href="#" onclick="showLogoutConfirm()"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
    <div class="main-content">
        <div class="notification-container">
            <div class="notification-header">
                <h1>Notifications</h1>
                <div class="notification-controls">
                    <button class="refresh-btn" id="refreshBtn" onclick="refreshAllNotifications()">
                        <i class="fas fa-sync-alt"></i> Refresh All
                    </button>
                </div>
            </div>
            <div class="notification-layout">
                <div class="notification-column">
                    <div class="column-header">
                        <div class="column-header-title">
                            <i class="fas fa-user-shield"></i>
                            <h2>SuperAdmin Notifications</h2>
                        </div>
                        <button class="clear-all-btn" id="adminClearAllBtn" style="display: none;">
                            <i class="fas fa-trash-alt"></i> Clear All
                        </button>
                    </div>
                    <div class="stats-section">
                        <div class="stat-box">
                            <span class="stat-label">Total</span>
                            <span class="stat-value" id="admin-total-count">0</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Read</span>
                            <span class="stat-value" id="admin-read-count">0</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Unread</span>
                            <span class="stat-value" id="admin-unread-count">0</span>
                        </div>
                    </div>
                    <div class="notification-history" id="adminNotificationHistory">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                        </div>
                    </div>
                </div>
                <div class="notification-column">
                    <div class="column-header">
                        <div class="column-header-title">
                            <i class="fas fa-users-cog"></i>
                            <h2>Manager Notifications</h2>
                        </div>
                        <button class="clear-all-btn" id="managerClearAllBtn" style="display: none;">
                            <i class="fas fa-trash-alt"></i> Clear All
                        </button>
                    </div>
                    <div class="stats-section">
                        <div class="stat-box">
                            <span class="stat-label">Total</span>
                            <span class="stat-value" id="manager-total-count">0</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Read</span>
                            <span class="stat-value" id="manager-read-count">0</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Unread</span>
                            <span class="stat-value" id="manager-unread-count">0</span>
                        </div>
                    </div>
                    <div class="notification-history" id="managerNotificationHistory">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Page Loader -->
    <div class="page-loader" id="pageLoader">
        <div class="page-loader-content">
            <i class="fas fa-spinner"></i>
            <p>Loading notifications...</p>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Notification marked as read</span>
    </div>
    
    <script>
        // API base URL - using relative path
        const API_BASE_URL = '/api/admin/notifications';
        
        // Show toast notification
        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = toast.querySelector('i');
            
            // Set message
            toastMessage.textContent = message;
            
            // Set icon based on type
            if (type === 'success') {
                toastIcon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                toastIcon.className = 'fas fa-exclamation-circle';
            } else if (type === 'loading') {
                toastIcon.className = 'fas fa-spinner';
            }
            
            // Set toast class
            toast.className = `toast ${type}`;
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Hide toast after specified duration
            if (type !== 'loading') {
                setTimeout(() => {
                    toast.classList.remove('show');
                }, duration);
            }
        }
        
        // Show/hide page loader
        function showPageLoader(show = true) {
            const pageLoader = document.getElementById('pageLoader');
            if (show) {
                pageLoader.classList.add('active');
            } else {
                pageLoader.classList.remove('active');
            }
        }
        
        // Set loading state for refresh button
        function setRefreshButtonLoading(loading = true) {
            const refreshBtn = document.getElementById('refreshBtn');
            if (loading) {
                refreshBtn.classList.add('loading');
            } else {
                refreshBtn.classList.remove('loading');
            }
        }
        
        // Set loading state for clear button
        function setClearButtonLoading(role, loading = true) {
            const clearBtn = document.getElementById(`${role.toLowerCase()}ClearAllBtn`);
            if (clearBtn) {
                if (loading) {
                    clearBtn.classList.add('loading');
                    clearBtn.disabled = true;
                } else {
                    clearBtn.classList.remove('loading');
                    clearBtn.disabled = false;
                }
            }
        }
        
        // Set loading state for notification item
        function setNotificationItemLoading(notificationId, loading = true) {
            const notificationItem = document.querySelector(`.notification-item[data-notification-id="${notificationId}"]`);
            if (notificationItem) {
                if (loading) {
                    notificationItem.classList.add('loading');
                } else {
                    notificationItem.classList.remove('loading');
                }
            }
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, s => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[s]));
        }
        
        // Helper function to check if notification is read
        function isNotificationRead(notification) {
            // Debug log
            console.log(`Checking isRead for notification ${notification.id}:`, notification.isRead, typeof notification.isRead);
            
            // Handle different types of isRead values
            if (typeof notification.isRead === 'boolean') {
                return notification.isRead;
            } else if (typeof notification.isRead === 'string') {
                return notification.isRead === 'true' || notification.isRead === '1';
            } else if (typeof notification.isRead === 'number') {
                return notification.isRead === 1;
            }
            
            // Default to false if isRead is undefined or null
            return false;
        }
        
        // Update notification counts
        function updateNotificationCounts(role, notifications) {
            const totalCount = notifications.length;
            
            // Count read and unread notifications
            let readCount = 0;
            let unreadCount = 0;
            
            notifications.forEach(notification => {
                if (isNotificationRead(notification)) {
                    readCount++;
                } else {
                    unreadCount++;
                }
            });
            
            // Debug log
            console.log(`Notification counts for ${role}: Total=${totalCount}, Read=${readCount}, Unread=${unreadCount}`);
            
            // Update the UI
            document.getElementById(`${role}-total-count`).textContent = totalCount;
            document.getElementById(`${role}-read-count`).textContent = readCount;
            document.getElementById(`${role}-unread-count`).textContent = unreadCount;
        }
        
        // Populate notification history
        function populateNotificationHistory(containerId, notifications) {
            const historyContainer = document.getElementById(containerId);
            const clearAllBtn = document.getElementById(containerId.includes('admin') ? 'adminClearAllBtn' : 'managerClearAllBtn');
            const role = containerId.includes('admin') ? 'admin' : 'manager';
            
            if (!historyContainer) {
                return;
            }
            
            // Update counts
            updateNotificationCounts(role, notifications);
            
            // Show/hide Clear All button
            if (clearAllBtn) {
                clearAllBtn.style.display = notifications.length > 0 ? 'flex' : 'none';
            }
            
            if (notifications.length === 0) {
                historyContainer.innerHTML = `
                    <div class="no-notifications">
                        <i class="fas fa-inbox"></i>
                        <p>No notifications for ${role === 'admin' ? 'Admin' : 'Manager'} yet.</p>
                    </div>
                `;
                return;
            }
            
            historyContainer.innerHTML = '';
            notifications.forEach(notification => {
                // Check if sentAt is a valid date
                let date, formattedDate, formattedTime;
                if (notification.sentAt) {
                    try {
                        // Try to parse the date
                        date = new Date(notification.sentAt);
                        if (isNaN(date.getTime())) {
                            // If parsing fails, use current date
                            date = new Date();
                        }
                        formattedDate = date.toLocaleDateString();
                        formattedTime = date.toLocaleTimeString();
                    } catch (e) {
                        date = new Date();
                        formattedDate = date.toLocaleDateString();
                        formattedTime = date.toLocaleTimeString();
                    }
                } else {
                    date = new Date();
                    formattedDate = date.toLocaleDateString();
                    formattedTime = date.toLocaleTimeString();
                }
                
                // Debug: Log the isRead value
                console.log(`Notification ${notification.id}: isRead = ${notification.isRead} (${typeof notification.isRead})`);
                
                // Determine if notification is read or unread
                const isRead = isNotificationRead(notification);
                const isReadClass = isRead ? '' : 'unread';
                const statusText = isRead ? 'Read' : 'Unread';
                const statusClass = isRead ? '' : 'unread';
                
                // Determine priority class
                let priorityClass = 'priority-normal';
                if (notification.priority) {
                    const priority = notification.priority.toLowerCase();
                    if (priority === 'high') {
                        priorityClass = 'priority-high';
                    } else if (priority === 'medium') {
                        priorityClass = 'priority-medium';
                    }
                }
                
                historyContainer.innerHTML += `
                    <div class="notification-item ${isReadClass}" data-notification-id="${notification.id}" data-role="${role === 'admin' ? 'ADMIN' : 'MANAGER'}">
                        <div class="notification-spinner">
                            <i class="fas fa-spinner"></i>
                        </div>
                        <div class="notification-subject">${escapeHtml(notification.subject || 'No Subject')}</div>
                        <div class="notification-message">${escapeHtml(notification.message || 'No Message')}</div>
                        <div class="notification-footer">
                            <span class="notification-status ${statusClass}">${statusText}</span>
                            <div class="notification-meta">
                                <div class="notification-time">${formattedDate} at ${formattedTime}</div>
                                <div class="notification-priority ${priorityClass}">${notification.priority || 'Normal'}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Add click event listeners to notification items
            historyContainer.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', function() {
                    const notificationId = this.getAttribute('data-notification-id');
                    const role = this.getAttribute('data-role');
                    
                    // Only mark as read if it's currently unread
                    if (this.classList.contains('unread')) {
                        markAsRead(notificationId, role);
                    }
                });
            });
        }
        
        // Fetch notifications
        async function fetchNotifications(adminId, role) {
            try {
                const endpoint = role === 'admin' ? 'admin' : 'manager';
                const url = `${API_BASE_URL}/${endpoint}?adminId=${adminId}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to fetch ${role} notifications: ${errorText}`);
                }
                
                const notifications = await response.json();
                
                // Debug: Log the notifications
                console.log(`${role} notifications:`, notifications);
                
                populateNotificationHistory(`${endpoint}NotificationHistory`, notifications);
            } catch (error) {
                // Show error message
                const historyContainer = document.getElementById(`${role}NotificationHistory`);
                if (historyContainer) {
                    historyContainer.innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>Failed to load notifications: ${error.message}</span>
                        </div>
                    `;
                }
            }
        }
        
        // Mark notification as read
        async function markAsRead(notificationId, role) {
            const admin = JSON.parse(localStorage.getItem('admin'));
            if (!admin || !admin.id) {
                showToast('User not logged in', 'error');
                return;
            }
            
            try {
                // Set loading state for the notification item
                setNotificationItemLoading(notificationId, true);
                
                const url = `${API_BASE_URL}/mark-read?notificationId=${notificationId}&role=${role}&adminId=${admin.id}`;
                
                // Debug: Log the request
                console.log(`Marking notification as read: ${url}`);
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error('Failed to mark notification as read: ' + errorText);
                }
                
                const result = await response.json();
                
                // Debug: Log the result
                console.log('Mark as read result:', result);
                
                if (result === true) {
                    // Update the notification item immediately
                    const notificationItem = document.querySelector(`.notification-item[data-notification-id="${notificationId}"]`);
                    if (notificationItem) {
                        notificationItem.classList.remove('unread');
                        const statusBadge = notificationItem.querySelector('.notification-status');
                        if (statusBadge) {
                            statusBadge.classList.remove('unread');
                            statusBadge.textContent = 'Read';
                        }
                    }
                    
                    // Update the counts immediately
                    const roleLower = role.toLowerCase();
                    const unreadCountElement = document.getElementById(`${roleLower}-unread-count`);
                    const readCountElement = document.getElementById(`${roleLower}-read-count`);
                    
                    if (unreadCountElement && readCountElement) {
                        const currentUnread = parseInt(unreadCountElement.textContent);
                        const currentRead = parseInt(readCountElement.textContent);
                        unreadCountElement.textContent = currentUnread - 1;
                        readCountElement.textContent = currentRead + 1;
                    }
                    
                    // Show success message
                    showToast('Notification marked as read', 'success');
                    
                    // Refresh the notifications to ensure consistency
                    setTimeout(() => {
                        fetchNotifications(admin.id, roleLower);
                    }, 1000);
                } else {
                    showToast('Failed to mark notification as read', 'error');
                }
            } catch (error) {
                showToast('Failed to mark notification as read: ' + error.message, 'error');
            } finally {
                // Remove loading state for the notification item
                setNotificationItemLoading(notificationId, false);
            }
        }
        
        // Clear all notifications
        async function clearAllNotifications(role) {
            if (!confirm(`Are you sure you want to clear all ${role} notifications? This action cannot be undone.`)) {
                return;
            }
            
            const admin = JSON.parse(localStorage.getItem('admin'));
            if (!admin || !admin.id) {
                showToast('User not logged in', 'error');
                return;
            }
            
            try {
                // Set loading state for the clear button
                setClearButtonLoading(role, true);
                
                const url = `${API_BASE_URL}/clear?adminId=${admin.id}&role=${role}`;
                
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to clear ${role} notifications: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result === true) {
                    showToast(`${role} notifications cleared successfully`, 'success');
                    
                    // Refresh the notifications to get the updated state from the backend
                    await fetchNotifications(admin.id, role.toLowerCase());
                } else {
                    showToast(`Failed to clear ${role} notifications`, 'error');
                }
            } catch (error) {
                showToast(`Failed to clear ${role} notifications: ` + error.message, 'error');
            } finally {
                // Remove loading state for the clear button
                setClearButtonLoading(role, false);
            }
        }
        
        // Refresh all notifications
        async function refreshAllNotifications() {
            const admin = JSON.parse(localStorage.getItem('admin'));
            if (admin && admin.id) {
                try {
                    // Set loading states
                    setRefreshButtonLoading(true);
                    showToast('Refreshing notifications...', 'loading');
                    
                    // Fetch notifications for both admin and manager
                    await Promise.all([
                        fetchNotifications(admin.id, 'admin'),
                        fetchNotifications(admin.id, 'manager')
                    ]);
                    
                    // Hide loading toast
                    document.getElementById('toast').classList.remove('show');
                    
                    // Show success message
                    showToast('Notifications refreshed', 'success');
                } catch (error) {
                    showToast('Failed to refresh notifications', 'error');
                } finally {
                    // Remove loading state
                    setRefreshButtonLoading(false);
                }
            }
        }
        
        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true,
                timeZone: 'Asia/Kolkata'
            };
            const dateTimeString = now.toLocaleDateString('en-US', options) + ' IST';
            const dateTimeElement = document.getElementById('current-datetime');
            if (dateTimeElement) {
                dateTimeElement.textContent = dateTimeString;
            }
        }
        
        // Set profile image or initials
        function setProfileImage(user) {
            const profileAvatar = document.getElementById('profile-avatar');
            if (!profileAvatar) return;
            
            // Clear existing content
            profileAvatar.innerHTML = '';
            
            // Try to get saved photo from localStorage
            const savedPhoto = localStorage.getItem('profilePhoto');
            
            if (savedPhoto && savedPhoto.trim() !== '') {
                // Use saved photo
                const img = document.createElement('img');
                img.src = savedPhoto;
                img.alt = 'Profile';
                profileAvatar.appendChild(img);
            } else if (user.profilePicturePath && user.profilePicturePath.trim() !== '') {
                // Use profile picture from API response
                const img = document.createElement('img');
                img.src = user.profilePicturePath;
                img.alt = 'Profile';
                profileAvatar.appendChild(img);
                
                // Save to localStorage
                localStorage.setItem('profilePhoto', user.profilePicturePath);
            } else {
                // Show initials if no photo available
                const initials = (user.fullName || 'Admin').charAt(0).toUpperCase();
                profileAvatar.textContent = initials;
            }
        }
        
        // Load admin header data
        function loadAdminHeaderData() {
            const admin = JSON.parse(localStorage.getItem('admin'));
            if (!admin) {
                window.location.href = '/login.html';
                return;
            }
            
            fetch(`/api/admin/auth/admin/${admin.id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load admin profile');
                    }
                    return response.json();
                })
                .then(data => {
                    const headerName = document.querySelector('.admin-name');
                    const headerEmail = document.querySelector('.admin-email');
                    
                    if (headerName) headerName.textContent = data.fullName || 'Admin User';
                    if (headerEmail) headerEmail.textContent = data.email || 'admin@campus1.com';
                    
                    // Set profile image or initials
                    setProfileImage(data);
                    
                    localStorage.setItem('admin', JSON.stringify(data));
                })
                .catch(error => {
                    const headerName = document.querySelector('.admin-name');
                    const headerEmail = document.querySelector('.admin-email');
                    
                    if (headerName) headerName.textContent = admin.fullName || 'Admin User';
                    if (headerEmail) headerEmail.textContent = admin.email || 'admin@campus1.com';
                    
                    // Set profile image or initials from localStorage data
                    setProfileImage(admin);
                });
        }
        
        function logout() {
            localStorage.removeItem('admin');
            localStorage.removeItem('isLoggedIn');
            window.location.href = '/login.html';
        }
        
        function viewProfilePicture() {
            alert('Profile picture view feature would be implemented here');
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                window.location.href = '/login.html';
                return;
            }
            
            // Show page loader
            showPageLoader(true);
            
            loadAdminHeaderData();
            updateDateTime();
            setInterval(updateDateTime, 60000);
            
            const adminClearAllBtn = document.getElementById('adminClearAllBtn');
            const managerClearAllBtn = document.getElementById('managerClearAllBtn');
            
            if (adminClearAllBtn) {
                adminClearAllBtn.addEventListener('click', () => clearAllNotifications('ADMIN'));
            }
            
            if (managerClearAllBtn) {
                managerClearAllBtn.addEventListener('click', () => clearAllNotifications('MANAGER'));
            }
            
            const admin = JSON.parse(localStorage.getItem('admin'));
            if (admin && admin.id) {
                // Fetch notifications for both admin and manager
                Promise.all([
                    fetchNotifications(admin.id, 'admin'),
                    fetchNotifications(admin.id, 'manager')
                ]).finally(() => {
                    // Hide page loader
                    showPageLoader(false);
                });
            }
        });
    </script>
    
    <!-- Logout Confirm Modal -->
    <div id="logoutConfirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-sign-out-alt"></i> Confirm Logout</h3>
                <span class="close" onclick="closeLogoutConfirmModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to log out?</p>
                <div class="form-actions">
                    <button type="button" onclick="closeLogoutConfirmModal()" class="btn-cancel">Cancel</button>
                    <button type="button" onclick="performLogout()" class="btn-save">Logout</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Logout Success Modal -->
    <div id="logoutSuccessModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-check-circle"></i> Logout Successful</h3>
            </div>
            <div class="modal-body">
                <p>You have been logged out successfully.</p>
            </div>
        </div>
    </div>
    
    <script>
        // Function to check login status and redirect to login.html if not logged in
        function checkLoginStatus() {
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                window.location.replace('login.html'); // Use replace to prevent adding to history
            }
        }
        
        // Logout Modal Functions
        function showLogoutConfirm() {
            document.getElementById('logoutConfirmModal').style.display = 'block';
        }
        
        function closeLogoutConfirmModal() {
            document.getElementById('logoutConfirmModal').style.display = 'none';
        }
        
        function performLogout() {
            closeLogoutConfirmModal();
            // Clear all localStorage to invalidate session
            localStorage.clear();
            showLogoutSuccess();
        }
        
        function showLogoutSuccess() {
            document.getElementById('logoutSuccessModal').style.display = 'block';
            setTimeout(() => {
                // Use replace to avoid adding logout to history stack
                window.location.replace('login.html');
            }, 3000);
        }
        
        // Close modal when clicking outside of it
        window.addEventListener('click', function(event) {
            const logoutConfirmModal = document.getElementById('logoutConfirmModal');
            if (event.target === logoutConfirmModal) {
                closeLogoutConfirmModal();
            }
        });
        
        // Check login status on page load and when navigating back/forward
        window.addEventListener('DOMContentLoaded', checkLoginStatus);
        window.addEventListener('pageshow', function(event) {
            // Handle cached pages (e.g., back button)
            if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
                checkLoginStatus();
            }
        });
    </script>
</body>
</html>